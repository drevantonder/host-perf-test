name: Run Benchmarks

on:
  workflow_run:
    workflows: ["Deploy Benchmark Runner"]
    types: [completed]
  workflow_dispatch:
    inputs:
      regions:
        description: 'Space-separated list of regions to test (e.g., iad lhr syd)'
        required: false
        default: 'iad lhr syd'
      runs:
        description: 'Number of runs per region'
        required: false
        default: '10'
      label:
        description: 'Label for the benchmark run'
        required: false
        default: 'github-action'
      callback_url:
        description: 'URL to call with results when complete'
        required: false

permissions:
  contents: read

env:
  APP_NAME: host-perf-test
  REGIONS: ${{ inputs.regions || 'iad lhr syd' }}

jobs:
  run:
    if: |
      github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region: [iad, lhr, syd]
    concurrency:
      group: run-benchmarks-${{ matrix.region }}
      cancel-in-progress: true
    steps:
      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Discover app hostname
        id: host
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          APP_HOST=$(flyctl status --app $APP_NAME --json | jq -r '.Hostname // .hostname // empty')
          if [ -z "$APP_HOST" ]; then
            echo "Failed to get hostname for $APP_NAME" >&2
            exit 1
          fi
          echo "host=$APP_HOST" >> $GITHUB_OUTPUT
      - name: Scale to 1
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |     
          flyctl scale count 1 --region ${{ matrix.region }} --app $APP_NAME --yes
      - name: Run benchmark via /run
        id: run
        env:
          APP_HOST: ${{ steps.host.outputs.host }}
          BENCH_TOKEN: ${{ secrets.BENCH_TOKEN }}
        run: |
          RUNS=${{ inputs.runs || '10' }}
          LABEL=${{ inputs.label || matrix.region }}
          curl -fsS --retry 20 --retry-delay 5 --retry-all-errors --connect-timeout 5 --max-time 120 \
            -H "fly-prefer-region: ${{ matrix.region }}" \
            -H "Authorization: Bearer $BENCH_TOKEN" \
            "https://$APP_HOST/run?runs=$RUNS&label=$LABEL" \
            -o result-${{ matrix.region }}.json
      - name: Scale to zero
        continue-on-error: true
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl scale count 0 --region ${{ matrix.region }} --app $APP_NAME --yes
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.region }}
          path: result-${{ matrix.region }}.json

  aggregate:
    needs: run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Merge and summarize
        run: node .github/scripts/aggregate.js
      - name: Upload combined.json
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-combined
          path: combined.json
      - name: Job Summary
        run: cat SUMMARY.md >> $GITHUB_STEP_SUMMARY
      - name: Send results to callback URL
        if: ${{ inputs.callback_url != '' }}
        run: |
          if [ -f "combined.json" ]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d @combined.json \
              "${{ inputs.callback_url }}"
          else
            echo "No combined.json file found to send"
            exit 1
          fi
