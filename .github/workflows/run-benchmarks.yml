name: Run Benchmarks

on:
  workflow_run:
    workflows: ["Deploy Benchmark Runner"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

env:
  APP_NAME: host-perf-test
  REGIONS: 'iad lhr syd'

jobs:
  run:
    if: |
      github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region: [iad, lhr, syd]
    concurrency:
      group: run-benchmarks-${{ matrix.region }}
      cancel-in-progress: true
    steps:
      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Discover app hostname
        id: host
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          APP_HOST=$(flyctl status --app $APP_NAME --json | jq -r '.Hostname // .hostname // empty')
          if [ -z "$APP_HOST" ]; then
            echo "Failed to get hostname for $APP_NAME" >&2
            exit 1
          fi
          echo "host=$APP_HOST" >> $GITHUB_OUTPUT
      - name: Scale to 1
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |     
          flyctl scale count 1 --region ${{ matrix.region }} --app $APP_NAME --yes
      - name: Run benchmark via /run
        id: run
        env:
          APP_HOST: ${{ steps.host.outputs.host }}
          BENCH_TOKEN: ${{ secrets.BENCH_TOKEN }}
        run: |
          curl -fsS --retry 20 --retry-delay 5 --retry-all-errors --connect-timeout 5 --max-time 120 \
            -H "fly-prefer-region: ${{ matrix.region }}" \
            -H "Authorization: Bearer $BENCH_TOKEN" \
            "https://$APP_HOST/run?runs=10&label=${{ matrix.region }}" \
            -o result-${{ matrix.region }}.json
      - name: Scale to zero
        continue-on-error: true
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl scale count 0 --region ${{ matrix.region }} --app $APP_NAME --yes
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.region }}
          path: result-${{ matrix.region }}.json

  aggregate:
    needs: run
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Merge and summarize
        run: node .github/scripts/aggregate.js      - name: Upload combined.json
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-combined
          path: combined.json
      - name: Job Summary
        run: cat SUMMARY.md >> $GITHUB_STEP_SUMMARY
